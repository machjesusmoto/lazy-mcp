# blocked.md File Format Specification

**Version**: 1.0.0
**Date**: 2025-10-07
**Status**: Complete

## Purpose

The `blocked.md` file specifies which MCP servers and memory files should be disabled when Claude Code starts in a project directory. This file is read by Claude Code at runtime to filter out unwanted context.

## Location

```
<project-root>/.claude/blocked.md
```

**Path Rules**:
- Must be in the `.claude` directory of the project root
- Filename is case-sensitive: `blocked.md` (lowercase)
- Must be a markdown file (.md extension)

---

## File Format

### Structure

```markdown
# Blocked MCP Servers and Memory Files
# Generated by mcp-toggle
# Last updated: <ISO 8601 timestamp>

## MCP Servers
<mcp-entries>

## Memory Files
<memory-entries>
```

### Entry Format

**MCP Server Entry**:
```
mcp:<server-name>
```

**Memory File Entry**:
```
memory:<relative-path>
```

---

## Specification

### Header Section

```markdown
# Blocked MCP Servers and Memory Files
# Generated by mcp-toggle
# Last updated: 2025-10-07T10:30:00Z
```

**Rules**:
- First line: `# Blocked MCP Servers and Memory Files` (title)
- Second line: `# Generated by mcp-toggle` (generator tag)
- Third line: `# Last updated: <timestamp>` (ISO 8601 format)
- Blank line after header

**Purpose**: Human-readable header for documentation and timestamp tracking

---

### MCP Servers Section

```markdown
## MCP Servers
mcp:filesystem
mcp:sequential-thinking
mcp:playwright
```

**Rules**:
- Section header: `## MCP Servers`
- One entry per line
- Entry format: `mcp:<server-name>`
- `<server-name>` must match the key in .claude.json mcpServers object
- No quotes around server name
- No whitespace before/after colon
- Empty section allowed (no entries)
- Blank line after section

**Validation**:
- Server name must be non-empty
- Server name must be alphanumeric with hyphens/underscores (pattern: `[a-zA-Z0-9_-]+`)
- Duplicate entries ignored (only first occurrence matters)

**Examples**:
```markdown
## MCP Servers
mcp:filesystem
mcp:my-custom-server
mcp:server_123
```

---

### Memory Files Section

```markdown
## Memory Files
memory:old-notes.md
memory:archive/deprecated.md
memory:team/legacy-docs.md
```

**Rules**:
- Section header: `## Memory Files`
- One entry per line
- Entry format: `memory:<relative-path>`
- `<relative-path>` is relative to `.claude/memories/` directory
- Path separators use forward slash `/` (converted on Windows)
- Must end with `.md` extension
- No leading slash on path
- Empty section allowed (no entries)
- Blank line after section (optional at end of file)

**Validation**:
- Path must be non-empty
- Path must end with `.md`
- Path must not contain `..` (parent directory traversal)
- Path must not start with `/` (absolute path)
- Duplicate entries ignored (only first occurrence matters)

**Examples**:
```markdown
## Memory Files
memory:project-notes.md
memory:architecture/old-design.md
memory:archived/2024/notes.md
```

---

## Complete Example

```markdown
# Blocked MCP Servers and Memory Files
# Generated by mcp-toggle
# Last updated: 2025-10-07T10:30:15Z

## MCP Servers
mcp:filesystem
mcp:sequential-thinking

## Memory Files
memory:old-architecture.md
memory:archive/deprecated-notes.md

```

---

## Parsing Rules

### Line Processing

1. **Trim whitespace**: Remove leading/trailing spaces from each line
2. **Skip empty lines**: Ignore blank lines
3. **Skip comments**: Ignore lines starting with `#`
4. **Identify sections**: Lines starting with `##` are section headers
5. **Parse entries**: Lines with `mcp:` or `memory:` prefix are entries

### State Machine

```
START
  ↓
READ_LINE
  ├─ Empty/Comment → READ_LINE
  ├─ "## MCP Servers" → MCP_SECTION
  ├─ "## Memory Files" → MEMORY_SECTION
  └─ Other → IGNORE

MCP_SECTION
  ├─ "mcp:<name>" → Store MCP block
  ├─ "## Memory Files" → MEMORY_SECTION
  └─ Other → READ_LINE

MEMORY_SECTION
  ├─ "memory:<path>" → Store memory block
  └─ Other → READ_LINE
```

### Error Handling

**Invalid Entries**: Silently skipped, logged if debug enabled
- Malformed prefix (e.g., `mc:name` instead of `mcp:name`)
- Invalid characters in server name
- Invalid path in memory file entry
- Missing colon

**Empty File**: Valid, treated as no blocks

**Corrupted File**: Parse what's valid, skip invalid lines

**Missing File**: Valid, treated as no blocks

---

## Writing Rules

### File Creation

1. **Check existence**: If `.claude/` doesn't exist, create it (755 permissions)
2. **Create file**: Create `blocked.md` with 644 permissions
3. **Write content**: Use template with current timestamp
4. **Atomic write**: Write to temporary file, then rename (prevents corruption)

### File Updates

1. **Read existing**: Parse current blocked.md
2. **Merge changes**: Apply user's block/unblock operations
3. **Generate new**: Create complete file from scratch (don't patch)
4. **Write atomically**: temp file + rename
5. **Update timestamp**: Set current timestamp in header

### Formatting

```typescript
function generateBlockedMd(blocks: BlockedItem[]): string {
  const now = new Date().toISOString();
  const mcpBlocks = blocks.filter(b => b.type === 'mcp');
  const memoryBlocks = blocks.filter(b => b.type === 'memory');

  let content = `# Blocked MCP Servers and Memory Files\n`;
  content += `# Generated by mcp-toggle\n`;
  content += `# Last updated: ${now}\n\n`;

  content += `## MCP Servers\n`;
  for (const block of mcpBlocks) {
    content += `mcp:${block.identifier}\n`;
  }
  content += `\n`;

  content += `## Memory Files\n`;
  for (const block of memoryBlocks) {
    content += `memory:${block.identifier}\n`;
  }
  content += `\n`;

  return content;
}
```

---

## Runtime Integration

### Claude Code Processing

When Claude Code starts, it should:

1. **Check for blocked.md**: Look for `.claude/blocked.md` in current directory
2. **Parse if present**: Read and parse using rules above
3. **Filter MCP servers**: Skip loading any MCP server whose name is in blocked MCP list
4. **Filter memory files**: Skip loading any memory file whose relative path is in blocked memory list
5. **Log actions** (if debug enabled): Report which items were blocked

### Precedence Rules

- **blocked.md is project-local**: Only affects current project, not parent directories
- **Inherited MCPs can be blocked**: Blocking an inherited MCP prevents its loading for this project
- **Memory files same rule**: Can block inherited memory files
- **No cascade**: Blocking in parent directory doesn't affect child directories

---

## Version History

### 1.0.0 (2025-10-07)
- Initial specification
- Line-based format with type prefixes
- Section-based organization
- Markdown format for readability

### Future Considerations
- **Versioning**: Add version field if format changes significantly
- **Metadata**: Add reason/comment field for why item blocked
- **Expiration**: Add temporary blocks with expiration dates
- **Wildcards**: Support pattern matching (e.g., `mcp:test-*`)

---

## Example: Full Workflow

### Initial State (no blocked.md)
```
<file does not exist>
```

### User Blocks filesystem and sequential-thinking MCPs
Tool writes:
```markdown
# Blocked MCP Servers and Memory Files
# Generated by mcp-toggle
# Last updated: 2025-10-07T10:30:15Z

## MCP Servers
mcp:filesystem
mcp:sequential-thinking

## Memory Files

```

### User Blocks memory file archive/old.md
Tool updates:
```markdown
# Blocked MCP Servers and Memory Files
# Generated by mcp-toggle
# Last updated: 2025-10-07T10:35:22Z

## MCP Servers
mcp:filesystem
mcp:sequential-thinking

## Memory Files
memory:archive/old.md

```

### User Unblocks filesystem
Tool updates:
```markdown
# Blocked MCP Servers and Memory Files
# Generated by mcp-toggle
# Last updated: 2025-10-07T10:40:08Z

## MCP Servers
mcp:sequential-thinking

## Memory Files
memory:archive/old.md

```

---

## Testing Requirements

### Valid Files
- Empty sections
- Multiple entries in each section
- Mixed case in identifiers
- Paths with subdirectories
- Comments and extra whitespace

### Invalid Files
- Malformed entries (wrong prefix)
- Invalid characters
- Absolute paths
- Parent directory traversal
- Missing sections

### Edge Cases
- Very large files (1000+ entries)
- Unicode in paths/names
- Windows vs Unix path separators
- File doesn't exist
- File is read-only
- File is corrupted

---

## Security Considerations

- **Path Traversal**: Validate no `..` in memory file paths
- **Absolute Paths**: Reject any absolute path in memory entries
- **File Size**: Reasonable limit (e.g., 1MB) to prevent DOS
- **Encoding**: UTF-8 only, reject invalid encoding
- **Permissions**: File should be 644 (readable by user/group, writable by user)

---

This specification ensures blocked.md is:
- **Human-readable**: Can be manually edited with any text editor
- **Machine-parseable**: Simple, unambiguous format
- **Version-controllable**: Plain text, diff-friendly
- **Extensible**: Can add new sections or metadata in future
- **Robust**: Handles errors gracefully, fails safe
